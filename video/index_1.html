<!DOCTYPE html>
<html lang="en">
<head></head>
<body>
<button id="control_start_button" onclick="startRecording()">Start Recording</button>
<button id="control_stop_button" disabled>Stop Recording</button>
<video autoplay controls></video>

<script>

var streamObject = null;
navigator.getUserMedia  = navigator.getUserMedia ||
							  navigator.webkitGetUserMedia ||
							  navigator.mozGetUserMedia ||
							  navigator.msGetUserMedia;

  var errorCallback = function(e) {
    console.log('Reeeejected!', e);
  };

  // identifying sources
  function startRecording(){
	  MediaStreamTrack.getSources(function(sourceInfos) {
	  var audioSource = null;
	  var videoSource = null;

	  for (var i = 0; i != sourceInfos.length; ++i) {
		var sourceInfo = sourceInfos[i];
		if (sourceInfo.kind === 'audio') {
		  console.log(sourceInfo.id, sourceInfo.label || 'microphone');

		  audioSource = sourceInfo.id;
		} else if (sourceInfo.kind === 'video') {
		  console.log(sourceInfo.id, sourceInfo.label || 'camera');

		  videoSource = sourceInfo.id;
		} else {
		  console.log('Some other kind of source: ', sourceInfo);
		}
	  }

	  sourceSelected(audioSource, videoSource);
	});
}

// if source is selected
function sourceSelected(audioSource, videoSource) {
  var constraints = {
    audio: {
	  optional: [{sourceId: audioSource}]
    },
    video: {
	  optional: [{sourceId: videoSource}],
	}
  };

  // main streaming object
  navigator.getUserMedia(constraints, successCallback, errorCallback);
}

// if successfull then start streaming from the video source
var successCallback = function(stream){
	console.log("I am called in success : "+stream);
	

	var video = document.querySelector('video');
	video.controls = true;
	console.log("Preparing to start streem... ");
	
	streamObject = window.URL.createObjectURL(stream);
	video.src = streamObject;
	
	console.log("Enabling stop button... ");
	// stop button actions
	if(document.getElementById("control_stop_button")){
		var controlButton = document.getElementById("control_stop_button");
		controlButton.disabled = false;
		
		controlButton.onclick = function(e){
			console.log("Stop streaming...");
			stream.stop();
			video.controls = false;
			controlButton.disabled = true;
			//navigator.msSaveBlob(streamObject, "myfileweb.webm");
			//invokeSaveAsDialog(streamObject,"myfile");
			saveData("my-download.webm");
			
		//	stream = null;
		}
	};
	
	//if (navigator.getUserMedia) {
	//  navigator.getUserMedia({audio: true, video: true}, function(stream) {
	//	streamObject = window.URL.createObjectURL(stream);
	//	video.src = streamObject;
	 // }, errorCallback);
	//} else {
	//  video.src = 'somevideo.webm'; // fallback.
	//}
	
	var saveData = (function () {
		var a = document.createElement("a");
		document.body.appendChild(a);
		a.style = "display: none";
		return function (fileName) {
		//	var json = JSON.stringify(data),
			//blob = new Blob([stream], {type: "octet/stream"}),
			//blob = new Blob([streamObject], { type: 'video/webm' });
			//url = streamObject;
			url = window.URL.createObjectURL(stream);
			console.log(" video src : "+url);
			a.href = url;
			a.download = fileName;
			a.click();
			window.URL.revokeObjectURL(url);
		};
	}());

//	var data = { x: 42, s: "hello, world", d: new Date() },
//	fileName = "my-download.webm";

	
}
/*
function invokeSaveAsDialog(file, fileName) {
    if (!file) {
        throw 'Blob object is required.';
    }
	console.log("file type: "+file);
    if (!file.type || file.type == 'undefined') {
        file.type = 'video/webm';
    }

    var fileExtension = 'webm';

    if (fileName && fileName.indexOf('.') !== -1) {
        var splitted = fileName.split('.');
        fileName = splitted[0];
        fileExtension = splitted[1];
    }

    var fileFullName = (fileName || (Math.round(Math.random() * 9999999999) + 888888888)) + '.' + fileExtension;

    if (typeof navigator.msSaveOrOpenBlob !== 'undefined') {
        return navigator.msSaveOrOpenBlob(file, fileFullName);
    } else if (typeof navigator.msSaveBlob !== 'undefined') {
        return navigator.msSaveBlob(file, fileFullName);
    }

    var hyperlink = document.createElement('a');
    hyperlink.href = file;//window.URL.createObjectURL(file);
    hyperlink.target = '_blank';
    hyperlink.download = fileFullName;

    if (!!navigator.mozGetUserMedia) {
        hyperlink.onclick = function() {
            (document.body || document.documentElement).removeChild(hyperlink);
        };
        (document.body || document.documentElement).appendChild(hyperlink);
    }

    var evt = new MouseEvent('click', {
        view: window,
        bubbles: true,
        cancelable: true
    });

    hyperlink.dispatchEvent(evt);

    if (!navigator.mozGetUserMedia) {
        URL.revokeObjectURL(hyperlink.href);
    }
}
*/
  /*
  // Not showing vendor prefixes.
  navigator.getUserMedia({video: true, audio: true}, function(localMediaStream) {
    var video = document.querySelector('video');
    video.src = window.URL.createObjectURL(localMediaStream);

    // Note: onloadedmetadata doesn't fire in Chrome when using it with getUserMedia.
    // See crbug.com/110938.
    video.onloadedmetadata = function(e) {
      // Ready to go. Do some stuff.
    };
  }, errorCallback);
  */
</script>
</body>
</html>